#!/usr/bin/env bash

source ./bin/init-env

if [ $# -eq 0 ]
  then
    echo "Setting up dev db"
    echo "You can start either production or development"
    echo "e.g bin/db-setup dev"
    echo "e.g bin/db-setup prod"
fi

PF_TARGET="${1:-dev}"

POSSIBLE_VALUES=("prod" "dev")

if [[ ! " ${POSSIBLE_VALUES[@]} " =~ " ${PF_TARGET} " ]]; then
  echo "target should be either: prod or dev"
  exit 1
fi

./bin/services-start "$@" && \
  ./bin/server-start "${PF_TARGET}"

case "${PF_TARGET}" in
  'prod')
    SERVICE_ENV='prod'
  ;;
  'dev')
    SERVICE_ENV='dev'
  ;;
esac

docker exec -it ${SERVICE_NAME}-${SERVICE_ENV}-app bash -c 'bin/rails db:create db:migrate db:seed'